---
title: "Data Wrangling - Multiple Header Lines"
author: "Skyler Elmstrom"
date: "12/7/2020"
output:
  html_document:
    code_folding: show
    code_download: true
---

<!--- Setup and Rmd Dependencies --->
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=F, warning=F)
library(knitr)
```

# The Problem
Eric shared a benthic organisms data set from the [SF Estuary EMP](https://emp.baydeltalive.com/projects/11280) that was inconvenient for R processing for several reasons:

* There are multiple header lines
* The data set was designed to be an Excel matrix, not an R data frame
* The true header row contains *sum* numerical values (pun intended), not the desired column names

I think you'll find that this is a very common set of problems with published excel data. This data actually seems to be two tables crammed into one: the taxonomic information of each species and the actual study data. Here is the simplest strategy I could come up for this scenario based on my limited knowledge:

1. Preserve the original multi-header
2. Collapse Genus and Species together into a list to use as new column headers
3. Modify the original data
    + 3a. Remove multi-header
    + 3b. Apply Genus Species list
    + 3c. Fix data frame headers

<br>

## Loading Data and Dependencies
It is important here to load the data without column names so that our first row of data isn't used as column names. I did this using a `col_names = F` argument when loading the data.
```{r}
# Dependencies
library(tidyverse)
library(readxl)

# Load Data
BenthicCPUE <- read_excel("Data/2011-2018_Benthic_CPUE_edited.xlsx", col_names = F) # load without column names
```
<br>

The structure of the data itself, as you can see, is not ideal:
<br>

```{r echo = F, results = 'show'}
knitr::kable(BenthicCPUE[1:10, 1:7])
```
<br><br>

## Preserve Original Headers
If you need to keep the original multi-header (i.e. the taxa), I would recommend creating a new table to store that information.
```{r}
# Preserve Original Multi-header (If Neccesary). Can Use as Lookup Table Later
Benthic.taxon <- BenthicCPUE[1:6,] %>% # add multi-header to new data.frame
  select(-num_range("...", 1:3)) # drop first three columns
```

```{r echo = F, results = 'show'}
knitr::kable(Benthic.taxon[1:6, 1:3])
```
<br><br>

## Collapse Genus and Species
As an example, I collapsed the Genus and Species values into one value using the base R `apply()` with a `collapse = " "` argument. I find R is a little easier to work with when working with rows, so I transposed the data to get my Genus:Species values into rows.
<br>

```{r}
# Transpose data
Benthic.taxon.t <- t(Benthic.taxon) # transpose table to long format
```
<br>

The collapse will create a separation between the values; in this case, the values will be separated by a space. This outputs a list of character objects.
```{r}

# Collapse Genus and Species
Benthic.GS <- apply(Benthic.taxon.t[,5:6], 1, paste, collapse=" ")
Benthic.GS <- Benthic.GS[2:411] # remove 'Genus: Species:' from list
```

```{r echo = F, results = 'show'}
knitr::kable(Benthic.GS[1:3])
```

<br><br>

## Modify Original Dataset
```{r}
# Remove Multi-header, transpose
BenthicCPUE.mod <- BenthicCPUE %>%
  slice(-(1:6)) %>% # Remove multi-header
  t # transpose
```

```{r}
# Apply Species List
BenthicCPUE.mod[5:414,1] <- Benthic.GS # replaces values within a range with our list

# Untranspose
BenthicCPUE.mod <- t(BenthicCPUE.mod)
```

```{r echo = F, results = 'show'}
knitr::kable(BenthicCPUE.mod[1:3, 1:7])
```
<br><br>

**Final Output:**
```{r}
# Fix headers
colnames(BenthicCPUE.mod) <- as.character(unlist(BenthicCPUE.mod[1,]))
BenthicCPUE.mod = BenthicCPUE.mod[-1, ]
```

```{r echo = F, results = 'show'}
knitr::kable(BenthicCPUE.mod[1:3, 1:7])
```
<br><br>

<details>
  <summary><b>Final Code - Condensed</b></summary>
```{r eval = F}
# Dependencies
library(tidyverse)
library(readxl)

# Load Data
BenthicCPUE <- read_excel("Data/2011-2018_Benthic_CPUE_edited.xlsx", col_names = F) # load without column names

# Preserve Original Multi-header (If Neccesary). Can Use as Lookup Table Later
Benthic.taxon <- BenthicCPUE[1:6,] %>% # add multi-header to new data.frame
  select(-num_range("...", 1:3)) # drop first three columns

### Collapse ###
# Transpose data
Benthic.taxon.t <- t(Benthic.taxon) # transpose table to long format

# Collapse Genus and Species
Benthic.GS <- apply(Benthic.taxon.t[,5:6], 1, paste, collapse=" ")
Benthic.GS <- Benthic.GS[2:411] # remove 'Genus: Species:' from list

### Modify Original Dataset ###
# Remove Multi-header, transpose
BenthicCPUE.mod <- BenthicCPUE %>%
  slice(-(1:6)) %>% # Remove multi-header
  t # transpose

# Apply Species List
BenthicCPUE.mod[5:414,1] <- Benthic.GS # replaces values within a range with our list

# Untranspose
BenthicCPUE.mod <- t(BenthicCPUE.mod)
```
</details>
<br>
  
<details>
  <summary><b>R Session Information</b></summary>
```{r echo = F}
xfun::session_info('rmarkdown')
```
</details>
<br><br>
